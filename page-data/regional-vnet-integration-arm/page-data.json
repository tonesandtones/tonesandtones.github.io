{"componentChunkName":"component---src-templates-post-template-js","path":"/regional-vnet-integration-arm/","webpackCompilationHash":"65876d4c71c36fb5ed69","result":{"data":{"post":{"id":"1c796584-f417-5954-b3da-f5b016fed17d","html":"<p>Azure App Service has a networking feature called VNet Integration, which allows outbound traffic from your App Service app to be pushed into a private VNet rather than go directly to the public internet. This can be really useful if you need to reach resources or servers inside a VNet, or over an ExpressRoute connection to on-premises, or send all outbound traffic via an egress controller on your security perimeter, or … etc etc.</p>\n<p>The docs are really quite good at explaining the feature and when/where/why/how you use it. <a href=\"https://docs.microsoft.com/en-us/azure/app-service/web-sites-integrate-with-vnet\">https://docs.microsoft.com/en-us/azure/app-service/web-sites-integrate-with-vnet</a></p>\n<p>There are two distinct flavours of VNet Integration, <a href=\"https://docs.microsoft.com/en-us/azure/app-service/web-sites-integrate-with-vnet#regional-vnet-integration\">Regional</a> and <a href=\"https://docs.microsoft.com/en-us/azure/app-service/web-sites-integrate-with-vnet#gateway-required-vnet-integration\">Gateway-Required</a>. Gateway-Required has been around for a while and uses a point-to-site VPN to get traffic into your VNet. Regional is much newer and simpler to use, and is what this post is about.</p>\n<h2>Also Known As - AKA:</h2>\n<p>There have been a variety of terms attached to the Regional VNet Integration feature throughout its development and release, and you sometimes see them in documentation and APIs, you might see some of them in your travels. They all refer in some way to Regional VNet Integration as opposed to Gateway-Required:</p>\n<ul>\n<li>Swift - this one comes up in the REST API methods and payloads, and in ARM templates.</li>\n<li>New VNet - common in blog posts and articles from 2018 to late 2019, when Regional was still in preview or only just GA.</li>\n<li>VNet Injection - the docs sometimes refer to vnet injection without defining the term.</li>\n</ul>\n<h2>How <em>NOT</em> to deploy Regional VNet Integration</h2>\n<p>If, like me, you go to the ARM reference documentation and look under <a href=\"https://docs.microsoft.com/en-us/azure/templates/microsoft.web/allversions\">Microsoft.Web</a>, you’ll see <code class=\"language-text\">sites/virtualNetworkConnections</code> and <code class=\"language-text\">sites/slots/virtualNetworkConnections</code>.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/6a483cc2b3e7deafaeadf633495dfc0a/9bac8/arm-docs-virtualnetworkconnections.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 75.74421168687982%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAA7DAAAOwwHHb6hkAAACAklEQVQ4y3VTW8+TUBD8/v9fMTHGV40++axPjV/TqkkrBdpyP3fOGXe3FGjVQ4YFAsPszJ4X0DLWw1qLcRwRYxTIc2PQdR26oYO2CvNKU5nqqTHICLxe+GStQ9/38N7TS0lqHOPysSYQX+wTkiPwkW5g1kY5VIOT+4nQIssytG0rHHdC40nhsYd7l254kzBukvwlxYmQVj3cCGeFgQjquplbFUK+TvLpJDMtvUq7C2HRGuTS8krh+XyeX7grdKODLg38J7LhM+ED+frqYIJZFBJ6Ewh+aTmEgKqqoLV+UBhigOvoeg+MO/JwC7giwHorgdz1Sij1KhTvHPI8R5EXEhD/YIy3xLkGOhLi1P5jy4xOe7R6pZAVNU0jCueUiYyt6LseqleIgTyNK+/SMjbnzqIkrMbGSigDjQ7PniikmVyvhMdxWUJJuPRWSLF46FEUJZy7RR88tZhIobLQH8mz9wnmLYX0Jf5FyoT/bLksyzkUrqxSLOPRrAkVYcCTh1Mo9VMoPIc8NgUFw6Gwn2yDJ9K9O+G7P2LjD/jlChhtxN+1SmWfxoZbZUIeHfZuUIOodt5hMxzwTf3EV/UD2+EIrfS8AdZ7+bTey0IyDHMYz4H8b633cq2mvZyda/wuKxzyi9SqqrF93WK320vrNeFyvUq9Xit61srPGdwZW8TdsG18/wfnw5MV23HiHQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"ARM reference docs - Microsoft.Web/sites/virtualNetworkConnections\"\n        title=\"\"\n        src=\"/static/6a483cc2b3e7deafaeadf633495dfc0a/8ff1e/arm-docs-virtualnetworkconnections.png\"\n        srcset=\"/static/6a483cc2b3e7deafaeadf633495dfc0a/9ec3c/arm-docs-virtualnetworkconnections.png 200w,\n/static/6a483cc2b3e7deafaeadf633495dfc0a/c7805/arm-docs-virtualnetworkconnections.png 400w,\n/static/6a483cc2b3e7deafaeadf633495dfc0a/8ff1e/arm-docs-virtualnetworkconnections.png 800w,\n/static/6a483cc2b3e7deafaeadf633495dfc0a/9bac8/arm-docs-virtualnetworkconnections.png 907w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>This is not the ARM resource type you want! This is for Gateway-Required VNet Integration.</p>\n<p align=\"center\">\n  <img src=\"https://media.giphy.com/media/GYeLcrWi5DMqs/giphy.gif\" alt=\"It&apos;s a trap!\">\n</p>\n<p>If you use a <a href=\"https://docs.microsoft.com/en-us/azure/templates/microsoft.web/2019-08-01/sites/virtualnetworkconnections\">Microsoft.Web/sites/virtualNetworkConnections</a> resource type, you’ll configure a Gateway-Required integration. Even if you don’t do it correctly, which I didn’t, ARM won’t report any issues, and the integration will not work.</p>\n<p>A helpful Microsoft support engineer was able to diagnose my problem - that I had (mis)configured a Gateway-Required VNet Integration - and pointed me to the correct way to set it up with ARM.</p>\n<h2>The solution</h2>\n<p>Stackoverflow to the rescue!</p>\n<p><a href=\"https://stackoverflow.com/questions/54534924/arm-template-for-to-configure-app-services-with-new-vnet-integration-feature/59857601#59857601\">https://stackoverflow.com/questions/54534924/arm-template-for-to-configure-app-services-with-new-vnet-integration-feature/59857601#59857601</a></p>\n<p>The resource type you want is <code class=\"language-text\">Microsoft.Web/sites/networkConfig</code> (and <code class=\"language-text\">.../sites/slots/...</code> if you’re using them), not <code class=\"language-text\">Microsoft.Web/sites/virtualNetworkConnections</code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\"><span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"type\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Microsoft.Web/sites/networkConfig\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"[concat(parameters('webAppName'),'/VirtualNetwork')]\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"apiVersion\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2016-08-01\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"properties\"</span><span class=\"token operator\">:</span>\n  <span class=\"token punctuation\">{</span>\n    <span class=\"token property\">\"subnetResourceId\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"[parameters('subnetResourceId')]\"</span><span class=\"token punctuation\">,</span>\n    <span class=\"token property\">\"swiftSupported\"</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">Microsoft.Web/sites/networkConfig</code> appears to be entirely undocumented in the official ARM docs, but it <strong>does</strong> appear in the ARM schema, which you can <a href=\"https://github.com/Azure/azure-resource-manager-schemas/blob/ff320d13e002510dc247f13440a3e70fa70ad479/schemas/2018-11-01/Microsoft.Web.json#L1007\">find on GitHub</a>. Note the end of the <code class=\"language-text\">name</code> <strong>must</strong> be <code class=\"language-text\">/virtualNetwork</code>, you can’t change it.</p>\n<p>That’s it for the solution. If you’re interested in knowing how to tell whether the thing you’ve configured is a Gateway-Required or Regional VNet Integration, read on!</p>\n<h2>The diagnosis</h2>\n<p>Our friend here is the Azure Resource Explorer, <a href=\"https://resources.azure.com\">https://resources.azure.com</a>. If you’ve never seen it, take a moment to explore, it’s a really useful way to see details that are not surfaced in the Azure portal.</p>\n<p>Here’s what to look for to check you’ve set up your Regional VNet Integration correctly.</p>\n<p><em>Navigate to the web app’s <code class=\"language-text\">config/virtualNetwork</code> node</em></p>\n<p><code class=\"language-text\">Subscriptions --&gt; {subscription} --&gt; resourceGroups --&gt; {resource group} --&gt; providers --&gt; Microsoft.Web --&gt; {web app} --&gt; config --&gt; virtualNetwork</code></p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/fcb8dca0bff3b48fd4b23531b6a825db/b5cbf/arm-vnet-integration-resources-virtualnetwork.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 39.90895295902883%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAA7DAAAOwwHHb6hkAAABlElEQVQY03VQXU/bMBTN3+5f6AtsGpo2VZo2tULQbd1AoEGhwFBB0NBN40NDbVgSEtdO7cRx7Nimodtt33d0deXzcM49xw4XIk1TyrJCqlKVs9lMaz2fzwkhzWaz1WrBbjQaR72e+4cPR5hOCSYkz0UhhGOM0caGiPi+H0WPsCljIM4YS5KEUQp2f/8DB+5UVTV6CLZ2u/uHR3v73SDwmcpCknDOKQRTptRGSolwEiEcTwhdOiqlFpetMUrbiFtpn8FPlbKP3CuWFwIEJEYYYQyCfv/seImB64KX53lLsTWFLB+n0APsVFEUjLLND+92tzeDh+utTxvbX9pv3r6u1Wrt9vphb69erwO9vDx3nmd2XlkI7+GcclU9Wcao4Fk2dCc3F3h0lfz+md5dT6LYD8I4jjGeACAIY6nTcdFiBuizu5iNi/jXGPGMvX/x8uvaq7vTbo69ILw/OPh2fNLtdD6urq6E0Zim8f3o1smlFkpPuQoTwWUJlOeCZelwZyfpfxc/BopRpUslJTSCqgJ+cEHgKf8BdmukswkJ2hkAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"resources.azure.com web app virtualNetwork node\"\n        title=\"\"\n        src=\"/static/fcb8dca0bff3b48fd4b23531b6a825db/8ff1e/arm-vnet-integration-resources-virtualnetwork.png\"\n        srcset=\"/static/fcb8dca0bff3b48fd4b23531b6a825db/9ec3c/arm-vnet-integration-resources-virtualnetwork.png 200w,\n/static/fcb8dca0bff3b48fd4b23531b6a825db/c7805/arm-vnet-integration-resources-virtualnetwork.png 400w,\n/static/fcb8dca0bff3b48fd4b23531b6a825db/8ff1e/arm-vnet-integration-resources-virtualnetwork.png 800w,\n/static/fcb8dca0bff3b48fd4b23531b6a825db/6ff5e/arm-vnet-integration-resources-virtualnetwork.png 1200w,\n/static/fcb8dca0bff3b48fd4b23531b6a825db/b5cbf/arm-vnet-integration-resources-virtualnetwork.png 1318w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Note the properties you set in the ARM template. They’re not exactly the same as in the ARM template, but pretty close:</p>\n<ul>\n<li><code class=\"language-text\">&quot;name&quot;: &quot;virtualNetwork&quot;</code></li>\n<li><code class=\"language-text\">&quot;type&quot;: &quot;Microsoft.Web/sites/config&quot;</code></li>\n<li><code class=\"language-text\">&quot;swiftEnabled&quot;: true</code></li>\n</ul>\n<p><em>Navigate to the web app’s <code class=\"language-text\">site/virtualNetworkConnections</code> node</em></p>\n<p><code class=\"language-text\">Subscriptions --&gt; {subscription} --&gt; resourceGroups --&gt; {resource group} --&gt; providers --&gt; Microsoft.Web --&gt; {web app} --&gt; virtualNetworkConnections</code></p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/930f384316a5522a7185dd135594375a/a7ca4/arm-vnet-integration-resources-virtualnetworkconnections.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 50.50038491147036%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAA7CAAAOwgEVKEqAAAACCElEQVQoz1WSW28SQRSA94H6+4zx90hKSNSnJmqthEpMu5AgJSLh0rDBVjQWC0XKZXfDRSnQZWGXndvuzl6AOrQv+mUyDzP5zjlzznAQY8AwGAACYJmmZVnr9ZqdJZNJnufj8fjR8XH6JPWjO/nZ1xbzLQBA0yQcdRzPcwGhowWBJnUdxzTN1WrFgum6zsIhjAkhGCGH0rv/2cqu6wBiTTSsLIllU5Z5iZcGWCKEwENVAI5v1akymy30uW5Q5jgOxngrO64DiT3ViI6Yu81cm9Vm+hQZSGcuhDZ1x1Ol1e52Zfn6uo0Rtm3a6/W5e5cuIRmpECCT2jaT2XW70xHFltRuCMV85uRjIZspZD8VsxlRap1Xyjx/NJ6MueyVUpJAuWd+HVq1CT3rm/KUvRPmYrGz2Nt8PFITUoOr8rBR/vxhP88fxl/sJqMHp0Kx2fzFYdtN50ov997sR94fRKLvDmO//9y4njcbDi7zuV7jwlBkbdz7XioU06mLL8K5UGo1G3NNMYwlx5r2+MlTjuMCgQDbH+3sfKtUVuvVZb0aff1KEE5V/RZiY66pc11VtZkki9VqtV6vDYdDzvHXiVTmWTAYCoWCwWA4HJYlybRtT53fiaIz6FsAsPZQtu7xPZ/9AjZL3/e5jijvhp8nEonNZvMwPTZhiBBRVXIzspSpTbDN2vgP1j0s0F9vz/tHQLcZOQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"resources.azure.com web app virtualNetworkConnections node\"\n        title=\"\"\n        src=\"/static/930f384316a5522a7185dd135594375a/8ff1e/arm-vnet-integration-resources-virtualnetworkconnections.png\"\n        srcset=\"/static/930f384316a5522a7185dd135594375a/9ec3c/arm-vnet-integration-resources-virtualnetworkconnections.png 200w,\n/static/930f384316a5522a7185dd135594375a/c7805/arm-vnet-integration-resources-virtualnetworkconnections.png 400w,\n/static/930f384316a5522a7185dd135594375a/8ff1e/arm-vnet-integration-resources-virtualnetworkconnections.png 800w,\n/static/930f384316a5522a7185dd135594375a/6ff5e/arm-vnet-integration-resources-virtualnetworkconnections.png 1200w,\n/static/930f384316a5522a7185dd135594375a/a7ca4/arm-vnet-integration-resources-virtualnetworkconnections.png 1299w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>Note the value of the <code class=\"language-text\">name</code> property, this is the important bit;</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">&quot;name&quot;: &quot;{guid}_{app-service-plan-name}&quot;</code></pre></div>\n<p>Regional VNet Integration will result in the name field derived from the <code class=\"language-text\">resourceGuid</code> of the vnet and the name of the app service plan, <code class=\"language-text\">{guid}_{app-service-plan-name}</code>. If, like me, you used ARM to create a <code class=\"language-text\">virtualNetworkConnections</code> sub-resource (and hence created a Gateway-Required integration by mistake), then the name will not have the <code class=\"language-text\">{guid}_{app-service-plan-name}</code> format but will be whatever you set as the resource name in your ARM template.</p>\n<p>There’s also the <code class=\"language-text\">isSwift</code> property. If it’s set to true, then it means you’ve set up a Regional VNet Integration like you wanted.</p>\n<h2>Summary</h2>\n<p>This a bit of a long post, so here’s a tl-dr;</p>\n<ul>\n<li>Gateway-Required VNet Integration is configured with the ARM resource <code class=\"language-text\">Microsoft.Web/sites/virtualNetworkConnections</code>. You can’t use this for Regional.</li>\n<li>Regional VNet Integration is configured with <code class=\"language-text\">Microsoft.Web/sites/networkConfig</code> (or <code class=\"language-text\">Microsoft.Web/sites/slots/networkConfig</code>)</li>\n<li>No it’s not documented in the ARM reference docs 😑</li>\n<li>StackOverflow has the answer: <a href=\"https://stackoverflow.com/a/59857601\">https://stackoverflow.com/a/59857601</a></li>\n<li>There are clues in the Azure Resource Explorer (<a href=\"https://resources.azure.com\">https://resources.azure.com</a>) if you look carefully</li>\n</ul>","fields":{"slug":"/regional-vnet-integration-arm/","prefix":"2020-06-29"},"frontmatter":{"title":"Deploying Azure App Service Regional VNet Integration with ARM","author":"Anthony Attwood","category":"azure","cover":{"childImageSharp":{"resize":{"src":"/static/75c23bee92f93606af412b4d049f617d/c83a6/markus-winkler-aYPtEknQmXE-unsplash.jpg"}}}}},"authornote":{"id":"6d7e2776-f5bf-5717-9502-2abc45ca50f5","html":"<p><strong>Anthony Attwood</strong> I’m a consultant software engineer living and working in Perth, Australia, building solutions that solve real problems for customers.</p>"},"site":{"siteMetadata":{"facebook":{"appId":""}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/regional-vnet-integration-arm/","prev":{"id":"cd400aa1-b4e1-5b93-bc2f-4101c9d34375","fields":{"slug":"/azure-ad-and-the-unvalidatable-access-token/","prefix":"2020-02-25","source":"posts"},"frontmatter":{"title":"Azure AD and the Un-validatable Access Token","category":"authentication"}},"next":{"id":"5ed3a081-a2b3-587f-97cb-6fead614a564","fields":{"slug":"/key-vault-access-policies-with-arm/","prefix":"2020-08-26","source":"posts"},"frontmatter":{"title":"Azure Key Vault Access Policies with ARM","category":"azure"}},"source":"posts"}}}