{"componentChunkName":"component---src-templates-post-template-js","path":"/azure-ad-and-the-unvalidatable-access-token/","webpackCompilationHash":"65876d4c71c36fb5ed69","result":{"data":{"post":{"id":"cd400aa1-b4e1-5b93-bc2f-4101c9d34375","html":"<p>On any project with a backend API, you probably want to secure access to that API so that only authenticated users can call it. If you’re wanting to authenticate users that already exist in an Azure Active Directory tenant, then an Azure AD App Registration will probably be involved.</p>\n<p>This post aims to explain a major gotchya with using an Azure AD App Registration for securing access to an API, and assumes you’re reasonably familiar with modern authentication using OAuth and OIDC. In particular, the idea of acquiring an access token for a particular api (or “audience” in OAuth terms).</p>\n<p><em>Inspired by <a href=\"https://stackoverflow.com/questions/45317152/invalid-signature-while-validating-azure-ad-access-token-but-id-token-works\">this SO post</a> and a <a href=\"https://github.com/AzureAD/azure-activedirectory-identitymodel-extensions-for-dotnet/issues/609\">related Github issue</a></em></p>\n<h2>tl;dr</h2>\n<p>To get the Microsoft Identity Platform to issue access tokens you can pass to <em>your</em> api, you <em>need</em> to set up a custom scope in the App Registration’s <em>Expose an API</em> tab, and request that scope when you acquire the tokens. If you don’t, you will get access tokens that are intended to be presented to the Microsoft Graph API and cannot be validated by vanilla JWT middleware.</p>\n<h2>… continued …</h2>\n<p>If you’re reasonably familiar with OAuth and OIDC, you might think that it’s straightforward to;</p>\n<ul>\n<li>set up an App Registration in Azure AD,</li>\n<li>implement a login flow using your chosen authentication flow using the App Registration’s client id,</li>\n<li>request an access token via the <code class=\"language-text\">/token</code> endpoint, and lastly,</li>\n<li>present the access token to your api (usually as an <code class=\"language-text\">Authorization: Bearer {access_token}</code> header)</li>\n</ul>\n<p>Your API will then validate the token, ensure the subject represented by the token is allowed to access the desired resource, and execute the API call.</p>\n<h2>Gotchya</h2>\n<p>…And your API won’t be able to validate the token.</p>\n<p>The App Registration blade in the Azure Portal has a tab called <em>Expose an API</em>.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/80902ffb395d87dea4c391b24dc267f2/ed731/app-registration-api-no-scope.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 48.85807504078304%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAACE3AAAhNwEzWJ96AAABh0lEQVQoz4VRTW/UMBDNb+fChRN/gxsSpT2AkDhSFs5EFSq7qLsbJ/6IHTt2xo+xN90WpFJLTzP+mJn3npufd7J9++6qvXh/2V5cXv368PGT2u22N8Mg2pRiG+MJy7K0Oedn0cwLQJTxeN3vlLL4cr3B5tt3XH/dYJo8nlvNOFrSWlPOtS3N003ubl+S2L6i4fdrsmZPzgUyxpD3nmJMlFLiGCmteYnMjrgfNQepIHrBtE68YvQ47Fsc7n5ADltIOUDxGyUltNIIIYAbw08Tgg91X5DX+sbx5fEoYa2vh+wV+l5h5D2nDzbwnXOOZU+1wTiOXGPX3JzzJgSJoS9sdjw5sJ8L5nVqYXKanGskooqi7iFfz3l6ic3++Aa72xcw6jNLSJicRdd1PGCAED2cdYhz5CEz5vlplGZVsjCuSnTOV0ZsdvWrSDJaV7aloPhV7u89+xfnhtqMGJiNMbr6tyyJmXUYjWF29q/H/KN14FOryK+fIoRgNubsR5EXVmaFVWn02Lf/4Q9y9AMz1l+ltwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"App Registration blade - Expose an API  - no scopes\"\n        title=\"\"\n        src=\"/static/80902ffb395d87dea4c391b24dc267f2/8ff1e/app-registration-api-no-scope.png\"\n        srcset=\"/static/80902ffb395d87dea4c391b24dc267f2/9ec3c/app-registration-api-no-scope.png 200w,\n/static/80902ffb395d87dea4c391b24dc267f2/c7805/app-registration-api-no-scope.png 400w,\n/static/80902ffb395d87dea4c391b24dc267f2/8ff1e/app-registration-api-no-scope.png 800w,\n/static/80902ffb395d87dea4c391b24dc267f2/6ff5e/app-registration-api-no-scope.png 1200w,\n/static/80902ffb395d87dea4c391b24dc267f2/ed731/app-registration-api-no-scope.png 1226w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>When I first encountered this issue, I didn’t set up any scopes for my API because I thought;</p>\n<blockquote>\n<p>“This only lets me set up scopes - my API doesn’t need any scopes, I only want the verified subject details of a logged in user, which I can get from an access token”</p>\n</blockquote>\n<h2>So what do you actually get?</h2>\n<p>If you go through a login flow and acquire an id and access token with the App Registration set up like this, you’ll get an (decoded) id token that looks like something like this;</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">ID Token\n\nHeader\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"typ\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"JWT\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"kid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HlC0R**snip**\"</span>\n<span class=\"token punctuation\">}</span>\n\nPayload\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{app-registration-client-id}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://login.microsoftonline.com/{azure-ad-tenant-id}/v2.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582618197</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nbf\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582618197</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582622097</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"email\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anthony.attwood@****\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nonce\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{nonce-value}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"preferred_username\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anthony.attwood@***\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{subject-id}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"ver\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"2.0\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"**lots-more-claims**\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"**snip**\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Nothing particularly unexpected in the id token.</p>\n<p>The access token on the other hand… When decoded it’ll look something like this;</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">Access Token\n\nHeader\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"typ\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"JWT\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nonce\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"ekY15jb**snip**\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"x5t\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HlC0R**snip**\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"kid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HlC0R**snip**\"</span>\n<span class=\"token punctuation\">}</span>\n\nPayload\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"00000003-0000-0000-c000-000000000000\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://sts.windows.net/{azure-ad-tenant-id}/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582618197</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nbf\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582618197</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582622097</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"app_displayname\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{app-registration-name}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Anthony Attwood\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"User.Read profile openid email\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{different-sub-claim-to-the-id-token}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"unique_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anthony.attwood@***\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"upn\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anthony.attwood@***\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"**lots-more-claims**\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"**snip**\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Your API won’t be able to validate the access token, indeed, there’s a couple of things wrong with it if you intend to present it to <em>your own</em> api.</p>\n<ul>\n<li>The header has a <code class=\"language-text\">nonce</code> parameter. This breaks validation and is indeed what the SO post I mentioned at the start of the article is about. A regular JWT does not have a <code class=\"language-text\">nonce</code> parameter in the header.</li>\n<li>The <code class=\"language-text\">aud</code> claim (“aud” = audience) is a weird looking GUID that’s mostly zero’s, <code class=\"language-text\">00000003-0000-0000-c000-000000000000</code>. You’d probably expect it to be your App Registrations client id.</li>\n</ul>\n<p>The funny looking <code class=\"language-text\">aud</code> claim indicates that the access token is actually intended to be presented to the Microsoft Graph API, <em>not</em> your API. The Graph API knows how to validate that kind of token.</p>\n<h2>The missing piece of the puzzle</h2>\n<p>Remember the <em>Expose an API</em> tab where I didn’t set up any scopes? This is the missing piece of the puzzle.</p>\n<p>Even if your API doesn’t need any custom scopes — remember, your API might only care about knowing that the token was issued to a known logged in user — you still need to set up a custom scope and request it in your <code class=\"language-text\">/token</code> or <code class=\"language-text\">/authorize</code> request.</p>\n<p>Set up a custom scope in the <em>Expose an API</em> tab, and you’ll see your new scope in the list, which will always be prefixed with your <code class=\"language-text\">Application ID URI</code>.</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/03ca397605f5f1b3be88b00ff26d0077/c6f47/app-registration-api-with-scope.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 800px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 47.13275726630008%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAACE3AAAhNwEzWJ96AAABUklEQVQoz5VSbU7DMAzN/e8EmgbcAMEBGO3Wds1nmzRNbGxv3Qb/iPRkJ7Gfn52or841u/2b27+82qfn3fH947M5dV2jrW3yWppcSlMqECr59er/AdyhUl4RasXHta4rEgFmsv9dylgH3gfirFABwIcA3fEEfdeD1hqC9+CcE8zzDDFGmMIE8eqz5UVcgGTV2Xl0BJQTxDlGHPoevfdICThNExIR2fmivBSxm88gMXjhJIUxTdgTQQgB+SymBZ21uCwLFkraAnlxjKU7LjKOIwlxsjfGyB0TK02b78MBx/NZlCQi4gRWuAUxKSPnjJnuWV1KSSwX3iCE3WikRZoFHSbU2iDND4dhQE0qmFwQJhkBgwvf7Bx/daFG60U+K6JvIgqtNdIKq9jUcfW85Jv/iC2GoSzNoW1btNQ6yqMkUcbtcpGZHoMDefjc1mPyHVW+HuMHBCm6nEd2LCUAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px transparent;\"\n        alt=\"App Registration blade - Expose an API  - with scope\"\n        title=\"\"\n        src=\"/static/03ca397605f5f1b3be88b00ff26d0077/8ff1e/app-registration-api-with-scope.png\"\n        srcset=\"/static/03ca397605f5f1b3be88b00ff26d0077/9ec3c/app-registration-api-with-scope.png 200w,\n/static/03ca397605f5f1b3be88b00ff26d0077/c7805/app-registration-api-with-scope.png 400w,\n/static/03ca397605f5f1b3be88b00ff26d0077/8ff1e/app-registration-api-with-scope.png 800w,\n/static/03ca397605f5f1b3be88b00ff26d0077/6ff5e/app-registration-api-with-scope.png 1200w,\n/static/03ca397605f5f1b3be88b00ff26d0077/c6f47/app-registration-api-with-scope.png 1273w\"\n        sizes=\"(max-width: 800px) 100vw, 800px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<h2>Now does it work?</h2>\n<p>Now when you acquire an access token, you request your special scope, and you’ll get back an access token in a different format that you can safely pass to your API.</p>\n<p>For simplicity and for when I don’t have a UI hooked up to do an interactive flow, I use an implicit flow to get tokens. So using a call to the <code class=\"language-text\">/token</code>,</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GET https://login.microsoftonline.com/{tenant-id}/oauth2/v2.0/authorize /\n  ?scope=api://thisismyappid/SuperSpecialScope profile email openid /\n  &amp;response_type=id_token token /\n  &amp;client_id={client-id} /\n  &amp;redirect_uri={some-imaginary-but-valid-redirect-uri} /\n  &amp;nonce={anything} /\n  &amp;state={anything}</code></pre></div>\n<p>Notice the scopes I’m requesting include the scope I just set up in the <em>Expose an API</em> tab.</p>\n<p>You get back an id token that still looks like it did before, but the access token looks different.</p>\n<div class=\"gatsby-highlight\" data-language=\"json\"><pre class=\"language-json\"><code class=\"language-json\">Access Token\n\nHeader\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"typ\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"JWT\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"alg\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"RS256\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"x5t\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HlC0RHlC0R**snip**\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"kid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"HlC0RHlC0R**snip**\"</span>\n<span class=\"token punctuation\">}</span>\n\nPayload\n<span class=\"token punctuation\">{</span>\n  <span class=\"token property\">\"aud\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"api://thisismyappid\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iss\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"https://sts.windows.net/{azure-ad-tenant-id}/\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"iat\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582620705</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"nbf\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582620705</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"exp\"</span><span class=\"token operator\">:</span> <span class=\"token number\">1582624605</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"appid\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{client-id}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"Anthony Attwood\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"scp\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"SuperSpecialScope\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"sub\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"{same-sub-as-the-id-token}\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"unique_name\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anthony.attwood@***\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"upn\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"anthony.attwood@***\"</span><span class=\"token punctuation\">,</span>\n  <span class=\"token property\">\"**lots-more-claims**\"</span><span class=\"token operator\">:</span> <span class=\"token string\">\"**snip**\"</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>A few things to notice about this new format of access token include;</p>\n<ul>\n<li>There’s no <code class=\"language-text\">nonce</code> parameter in the header</li>\n<li>The audience <code class=\"language-text\">aud</code> claim is now what we’ve configured in the App Registration as the <em>App Id URI</em>, not the special GUID that represents the Graph API</li>\n</ul>\n<p>This token will validate correctly using the JWKS signing material we can discover from the OpenIDConnect discovery document. We can get that by appending <code class=\"language-text\">/.well-known/openid-configuration</code> to the value of the issuer <code class=\"language-text\">iss</code> claim, for example, <code class=\"language-text\">https://sts.windows.net/{azure-ad-tenant-id}/.well-known/openid-configuration</code>. Your JWT validation middleware probably does this for you automatically based on the value of the <code class=\"language-text\">iss</code> claim.</p>\n<h2>The solution</h2>\n<p>By adding a custom claim to the App Registration’s <em>Expose an API</em> tab and requesting that scope when we acquire tokens, the Microsoft Identity Platform will now generate  access tokens that we can present to <em>our</em> API, and that will validate correctly by any compliant JWT middleware.</p>\n<p>Happy authenticating!</p>","fields":{"slug":"/azure-ad-and-the-unvalidatable-access-token/","prefix":"2020-02-25"},"frontmatter":{"title":"Azure AD and the Un-validatable Access Token","author":"Anthony Attwood","category":"authentication","cover":{"childImageSharp":{"resize":{"src":"/static/406416edbec377ad5298280fab5fc457/c83a6/hello-i-m-nik-v8pL84kvTTc-unsplash.jpg"}}}}},"authornote":{"id":"6d7e2776-f5bf-5717-9502-2abc45ca50f5","html":"<p><strong>Anthony Attwood</strong> I’m a consultant software engineer living and working in Perth, Australia, building solutions that solve real problems for customers.</p>"},"site":{"siteMetadata":{"facebook":{"appId":""}}}},"pageContext":{"isCreatedByStatefulCreatePages":false,"slug":"/azure-ad-and-the-unvalidatable-access-token/","prev":{"id":"947bd3ac-97c4-5e49-b5b0-457fac8c5623","fields":{"slug":"/sql-server-express-localdb-jdbc/","prefix":"2019-12-11","source":"posts"},"frontmatter":{"title":"SQL Server Express LocalDB via JDBC","category":"databases"}},"next":{"id":"1c796584-f417-5954-b3da-f5b016fed17d","fields":{"slug":"/regional-vnet-integration-arm/","prefix":"2020-06-29","source":"posts"},"frontmatter":{"title":"Deploying Azure App Service Regional VNet Integration with ARM","category":"azure"}},"source":"posts"}}}